<div class="profile-container">
  <div class="profile-header">
    <div class="profile-info">
      <div class="avatar">
        <img *ngIf="user.profilPhoto" [src]="user.profilPhoto" alt="Avatar" />
        <span *ngIf="!user.profilPhoto">{{ user.nom.charAt(0) || 'U' }}</span>
      </div>
      <div class="user-text">
        <h2>{{ user.nom }}</h2>
        <p class="email">{{ user.email }}</p>
        <p class="city">{{ user.ville }}</p>
      </div>
    </div>

    <button class="edit-btn" (click)="isEditing = !isEditing">
      <i class="fa fa-edit"></i>
      {{ isEditing ? 'Cancel' : 'Edit Profile' }}
    </button>
  </div>

  <!-- MODAL (édition du profil) - AMÉLIORÉ -->
  <div class="modal-backdrop" *ngIf="isEditing" (click)="isEditing = false"></div>
  <div class="modal edit-profile-modal" *ngIf="isEditing">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><i class="fa fa-user-edit"></i> Edit Profile</h3>
        <button class="close-btn" (click)="isEditing = false">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <form (ngSubmit)="onSubmit()" #editForm="ngForm" class="profile-edit-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="nom"><i class="fa fa-user"></i> Full Name</label>
            <input id="nom" type="text" name="nom" [(ngModel)]="user.nom" placeholder="Enter your full name" required />
          </div>

          <div class="form-group">
            <label for="email"><i class="fa fa-envelope"></i> Email</label>
            <input id="email" type="email" name="email" [(ngModel)]="user.email" placeholder="Enter your email" required />
          </div>

          <div class="form-group">
            <label for="ville"><i class="fa fa-map-marker-alt"></i> City</label>
            <input id="ville" type="text" name="ville" [(ngModel)]="user.ville" placeholder="Enter your city" />
          </div>

          <div class="form-group">
            <label for="password"><i class="fa fa-lock"></i> New Password</label>
            <input id="password" type="password" name="motDePasse" [(ngModel)]="newPassword" placeholder="Leave blank to keep current password" />
            <small class="help-text">Leave blank if you don't want to change your password</small>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn-save">
            <i class="fa fa-check"></i> Save Changes
          </button>
          <button type="button" class="btn-cancel" (click)="isEditing = false">
            <i class="fa fa-times"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab" [class.active]="activeTab === 'places'" (click)="setActive('places')">
      <i class="fa fa-map-marker-alt"></i> My Places
    </div>
    <div class="tab" [class.active]="activeTab === 'favorites'" (click)="setActive('favorites')">
      <i class="fa fa-heart"></i> Favorites
    </div>
  </div>

  <!-- PLACES (mes créations) -->
  <div class="content-box my-places" *ngIf="activeTab === 'places'">
    <!-- loading -->
    <div *ngIf="loadingPlaces">
      <div class="grid">
        <div class="card skeleton" *ngFor="let i of [0,1,2,3]"></div>
      </div>
    </div>

    <!-- error -->
    <div *ngIf="!loadingPlaces && placesError" class="notice error">
      {{ placesError }}
    </div>

    <!-- list -->
    <ng-container *ngIf="!loadingPlaces && !placesError">
      <div *ngIf="myPlaces.length > 0; else noPlaces" class="grid">
        <div class="card" *ngFor="let p of myPlaces">
          <!-- ===== Actions overlay (EDIT + DELETE) ===== -->
          <div class="fab">
            <button
              type="button"
              class="icon"
              title="Edit"
              aria-label="Edit place"
              (click)="openEdit(p)">
              <i class="fa fa-pen"></i>
            </button>
            <button
              type="button"
              class="icon danger"
              title="Delete"
              aria-label="Delete place"
              (click)="confirmDelete(p)"
              [disabled]="deletingId === p.id">
              <i class="fa fa-trash"></i>
            </button>
          </div>

          <div class="thumb" [class.placeholder]="!p.imageUrl">
            <div
              class="bg-img"
              [ngStyle]="{
                'background-image': p.imageUrl ? 'url(' + fullImg(p.imageUrl) + ')' : 'none'
              }"
            ></div>
          </div>

          <div class="meta">
            <div class="title">{{ p.name }}</div>

            <div class="addr" *ngIf="p.addressLine || p.city">
              <i class="fa fa-location-dot" aria-hidden="true"></i>
              <a
                [routerLink]="['/map']"
                [queryParams]="{ query: (p.addressLine || '') + (p.city ? ' ' + p.city : '') }"
                title="View on map"
                (click)="$event.stopPropagation()"
              >
                {{ p.addressLine }}<span *ngIf="p.city">, {{ p.city }}</span>
              </a>
            </div>

            <div class="chips">
              <span *ngIf="p.category" class="chip">{{ p.category }}</span>
              <span *ngIf="priceTag(p) as eur" class="chip">{{ eur }}</span>

              <!-- Ouvert/Fermé comme Community -->
              <span *ngIf="openStatus(p) as os"
                    class="chip"
                    [class.good]="os.cls === 'open' || os.cls === 'allday'"
                    [class.bad]="os.cls === 'closed'">
                {{ os.text }}
              </span>
            </div>

            <p *ngIf="p.shortDescription" class="desc">{{ p.shortDescription }}</p>
          </div>
        </div>
      </div>

      <ng-template #noPlaces>
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fa fa-map-marker-alt"></i>
          </div>
          <div class="title">No places yet</div>
          <div class="desc">You haven't added any places yet. Share your favorite local spots with the community!</div>
          <a class="cta" routerLink="/add-place">
            <i class="fa fa-plus"></i> Add Your First Place
          </a>
        </div>
      </ng-template>
    </ng-container>
  </div>

  <!-- FAVORITES -->
  <div class="content-box" *ngIf="activeTab === 'favorites'">
    <div *ngIf="transformedFavorites.length > 0; else noFavorites">
      <div class="grid">
        <app-place-card
          *ngFor="let fav of transformedFavorites"
          [place]="fav"
          [isFavorite]="true"
          [showRemoveButton]="true"
          (remove)="deleteFavorite(fav.placeId)">
        </app-place-card>
      </div>
    </div>

    <ng-template #noFavorites>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fa fa-heart"></i>
        </div>
        <div class="title">No favorites yet</div>
        <div class="desc">Start exploring and add places to your favorites to see them here.</div>
      </div>
    </ng-template>
  </div>
</div>

<!-- ==================== MODALE EDIT PLACE ==================== -->
<div class="modal-backdrop" *ngIf="editOpen" (click)="cancelEdit()"></div>
<div class="modal modal-wide" *ngIf="editOpen">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fa fa-edit"></i> Edit place</h3>
      <button class="close-btn" (click)="cancelEdit()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <form (ngSubmit)="submitEdit()" #placeForm="ngForm" class="edit-form">
      <div class="edit-grid">
        <!-- ligne 1 -->
        <input name="name" [(ngModel)]="editModel.name" placeholder="Name" required />
        <input name="category" [(ngModel)]="editModel.category" placeholder="Category" />

        <!-- ligne 2 -->
        <input name="addressLine" [(ngModel)]="editModel.addressLine" placeholder="Address line" />
        <input name="city" [(ngModel)]="editModel.city" placeholder="City" />

        <!-- ligne 3 -->
        <input name="postalCode" [(ngModel)]="editModel.postalCode" placeholder="Postal code" />
        <input name="country" [(ngModel)]="editModel.country" placeholder="Country" />

        <!-- description -->
        <textarea name="shortDescription" [(ngModel)]="editModel.shortDescription" placeholder="Short description"></textarea>

        <!-- prix -->
        <input type="number" name="avgPrice" [(ngModel)]="editModel.avgPrice" placeholder="Avg price" min="0" />
        <select name="priceRange" [(ngModel)]="editModel.priceRange">
          <option value="">(auto)</option>
          <option value="€">€</option>
          <option value="€€">€€</option>
          <option value="€€€">€€€</option>
        </select>

        <!-- === HOURS EDITOR === -->
        <div class="hours-editor" style="grid-column: 1 / -1;">
          <div class="hours-head">
            <div class="title">Opening hours</div>
            <div class="actions">
              <button type="button" class="btn tiny" (click)="copyMonToAll()">Copy Monday to all</button>
              <button type="button" class="btn tiny ghost" (click)="showRawHours = !showRawHours">
                {{ showRawHours ? 'Hide JSON' : 'Edit as JSON (advanced)' }}
              </button>
            </div>
          </div>

          <div class="hours-table">
            <div class="hours-row" *ngFor="let d of dayKeys">
              <div class="day">{{ dayLabel[d] }}</div>

              <label class="chk">
                <input type="checkbox"
                       [(ngModel)]="hours[d].closed"
                       name="closed-{{d}}"
                       (ngModelChange)="onClosedChange(d)" />
                Closed
              </label>

              <label class="chk">
                <input type="checkbox"
                       [(ngModel)]="hours[d].allDay"
                       name="allday-{{d}}"
                       (ngModelChange)="onAllDayChange(d)" />
                24h
              </label>

              <div class="times" *ngIf="!hours[d].closed && !hours[d].allDay">
                <input type="time" [(ngModel)]="hours[d].open"  name="open-{{d}}" />
                <span>–</span>
                <input type="time" [(ngModel)]="hours[d].close" name="close-{{d}}" />
              </div>
            </div>
          </div>

          <!-- JSON avancé (optionnel) -->
          <textarea *ngIf="showRawHours"
                    class="raw-json"
                    [(ngModel)]="editModel.openingHoursJson"
                    name="openingHoursJson"
                    placeholder='{"mon":{"open":"09:00","close":"18:00"}, ... }'></textarea>
        </div>

        <!-- photo -->
        <div class="file-row" style="grid-column: 1 / -1;">
          <label>New photo (optional)</label>
          <input type="file" (change)="onEditFile($event)" />
        </div>
      </div>

      <div class="modal-actions">
        <button type="submit" class="btn-save" [disabled]="savingEdit">
          <i class="fa fa-check"></i>
          {{ savingEdit ? 'Saving…' : 'Save' }}
        </button>
        <button type="button" class="btn-cancel" (click)="cancelEdit()">
          <i class="fa fa-times"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>